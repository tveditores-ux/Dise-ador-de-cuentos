<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Cuentos GracePrint</title>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4a6cf7; --accent: #ff6b6b; --bg: #fdfdfd; }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f7; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: var(--primary); margin-bottom: 25px; font-weight: 800; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .panel { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px dashed #cbd5e1; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #475569; }
        
        input[type="file"] { margin-bottom: 15px; }
        textarea { 
            width: 100%; height: 150px; padding: 15px; border-radius: 10px; border: 1px solid #ddd;
            font-family: 'Patrick Hand', cursive; font-size: 18px; box-sizing: border-box;
            background: #fff; line-height: 1.4;
        }
        
        .actions { margin-top: 20px; display: flex; gap: 10px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 16px; }
        .btn-gen { background: var(--primary); color: white; }
        .btn-pdf { background: var(--accent); color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        #preview { margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px; }
        #preview img { max-width: 100%; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .logo-footer { text-align: center; font-size: 12px; color: #94a3b8; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìñ GracePrint Story Studio</h1>
    
    <div class="grid">
        <div class="panel">
            <label>1. Ilustraciones (Izquierda)</label>
            <input type="file" id="images" multiple accept="image/*">
            <label>2. Papel Tapiz/Hoja (Derecha)</label>
            <input type="file" id="template" accept="image/*">
        </div>
        <div class="panel">
            <label>3. Pega el texto aqu√≠ (un p√°rrafo por p√°gina)</label>
            <textarea id="storyText" placeholder="Pega tu cuento aqu√≠...&#10;&#10;Ejemplo:&#10;Hab√≠a una vez un drag√≥n... (P√°gina 1)&#10;&#10;Entonces lleg√≥ el caballero... (P√°gina 2)"></textarea>
        </div>
    </div>

    <div class="actions">
        <button class="btn-gen" onclick="generarCuento()">‚ú® Crear P√°ginas</button>
        <button class="btn-pdf" onclick="exportarPDF()">üì• Descargar PDF HD</button>
    </div>

    <div id="preview"></div>
    <div class="logo-footer">Powered by GracePrint</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let paginasData = [];

async function generarCuento() {
    const imgFiles = document.getElementById('images').files;
    const templateFile = document.getElementById('template').files[0];
    // Dividimos el texto pegado por p√°rrafos
    const p√°rrafos = document.getElementById('storyText').value.split('\n').filter(p => p.trim() !== "");
    const previewDiv = document.getElementById('preview');

    if (!imgFiles.length || !templateFile) return alert('Por favor, selecciona las im√°genes y el fondo.');

    paginasData = [];
    previewDiv.innerHTML = '<h2>Vista de P√°ginas:</h2>';

    const tplImg = await loadImg(templateFile);

    for (let i = 0; i < imgFiles.length; i++) {
        const leftImg = await loadImg(imgFiles[i]);
        const texto = p√°rrafos[i] || ""; 

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Alta resoluci√≥n (4000px de ancho total para calidad premium)
        const h = 2000; 
        const lw = (leftImg.width * h) / leftImg.height;
        const rw = (tplImg.width * h) / tplImg.height;
        
        canvas.width = lw + rw;
        canvas.height = h;

        // Dibujar Ilustraci√≥n
        ctx.drawImage(leftImg, 0, 0, lw, h);
        // Dibujar Hoja de texto
        ctx.drawImage(tplImg, lw, 0, rw, h);

        // --- ESTILO DE TEXTO INFANTIL ---
        const paddingH = rw * 0.12;
        const paddingV = h * 0.15;
        const maxTextWidth = rw - (paddingH * 2);
        
        if (texto.length > 0) {
            // 1. Letra Capital
            ctx.fillStyle = "#1a365d"; // Azul oscuro elegante
            ctx.font = "bold 200px 'Patrick Hand', cursive";
            const primeraLetra = texto.charAt(0).toUpperCase();
            const restoDelTexto = texto.slice(1);
            
            ctx.fillText(primeraLetra, lw + paddingH, paddingV + 120);

            // 2. Resto del texto
            ctx.font = "70px 'Patrick Hand', cursive";
            ctx.fillStyle = "#334155";
            
            // Calculamos el espacio que ocupa la letra capital para mover el inicio del texto
            const capWidth = ctx.measureText(primeraLetra).width + 20;
            wrapText(ctx, restoDelTexto, lw + paddingH + capWidth, paddingV + 80, maxTextWidth - capWidth, 85, lw + paddingH, maxTextWidth);
        }

        // --- LOGO GRACEPRINT ---
        ctx.font = "bold 45px Arial";
        ctx.fillStyle = "rgba(0,0,0,0.2)"; // Color suave tipo marca de agua
        ctx.textAlign = "center";
        ctx.fillText("GracePrint", lw + (rw / 2), h - 80);
        ctx.textAlign = "left"; 

        const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
        paginasData.push({url: dataUrl, w: canvas.width, h: canvas.height});
        
        const pImg = document.createElement('img');
        pImg.src = dataUrl;
        previewDiv.appendChild(pImg);
    }
}

// Funci√≥n para envolver texto correctamente
function wrapText(ctx, text, x, y, maxWidth, lineHeight, originalX, fullWidth) {
    const words = text.split(' ');
    let line = '';
    let firstLine = true;

    for (let n = 0; n < words.length; n++) {
        let testLine = line + words[n] + ' ';
        let currentMaxWidth = firstLine ? maxWidth : fullWidth;
        let metrics = ctx.measureText(testLine);
        
        if (metrics.width > currentMaxWidth && n > 0) {
            ctx.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
            if (firstLine) {
                x = originalX; // Regresa al margen izquierdo tras la letra capital
                firstLine = false;
            }
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, x, y);
}

function loadImg(file) {
    return new Promise(res => {
        const i = new Image();
        i.onload = () => res(i);
        i.src = URL.createObjectURL(file);
    });
}

function exportarPDF() {
    if (!paginasData.length) return alert('Primero genera las p√°ginas.');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'px',
        format: [paginasData[0].w, paginasData[0].h]
    });

    paginasData.forEach((pag, i) => {
        if (i > 0) pdf.addPage([pag.w, pag.h], 'landscape');
        pdf.addImage(pag.url, 'JPEG', 0, 0, pag.w, pag.h);
    });

    pdf.save('Cuento_Personalizado_GracePrint.pdf');
}
</script>
</body>
</html>
