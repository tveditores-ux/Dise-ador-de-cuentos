<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Cuentos GracePrint</title>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4a6cf7; --accent: #ff6b6b; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: var(--primary); font-size: 24px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input, textarea, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        
        textarea { height: 100px; font-family: 'Patrick Hand', cursive; font-size: 18px; resize: vertical; }
        
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #3553ce; }
        .btn-export { background: var(--accent); }
        .btn-export:hover { background: #ee5252; }

        #preview { margin-top: 30px; }
        #preview img { max-width: 100%; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); margin-bottom: 20px; border: 1px solid #eee; }
        
        .hidden-canvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üé® GracePrint Story Maker</h1>
    
    <div class="controls">
        <div>
            <label>üñºÔ∏è Im√°genes del cuento (Lado izquierdo)</label>
            <input type="file" id="images" multiple accept="image/*">
        </div>
        <div>
            <label>üìú Fondo de la hoja (Lado derecho)</label>
            <input type="file" id="template" accept="image/*">
        </div>
    </div>

    <label>‚úçÔ∏è Escribe el texto del cuento (usa un salto de l√≠nea por cada p√°gina):</label>
    <textarea id="storyText" placeholder="Hab√≠a una vez...&#10;En un bosque lejano..."></textarea>
    
    <button onclick="generarCuento()">‚ú® Generar P√°ginas del Cuento</button>
    <button class="btn-export" onclick="exportarPDF()">üì• Exportar PDF Alta Definici√≥n</button>

    <div id="preview"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let paginasGeneradas = [];

async function generarCuento() {
    const imgFiles = document.getElementById('images').files;
    const templateFile = document.getElementById('template').files[0];
    const textContent = document.getElementById('storyText').value.split('\n').filter(t => t.trim() !== "");
    const previewDiv = document.getElementById('preview');

    if (!imgFiles.length || !templateFile) return alert('Por favor sube las im√°genes y el fondo.');
    
    paginasGeneradas = [];
    previewDiv.innerHTML = '<h3>Vista Previa:</h3>';

    const tplImg = await loadImg(templateFile);

    // Procesamos cada imagen subida
    for (let i = 0; i < imgFiles.length; i++) {
        const leftImg = await loadImg(imgFiles[i]);
        const textoPagina = textContent[i] || ""; // Si no hay m√°s texto, queda vac√≠o

        // Configuraci√≥n de Canvas HD (300 DPI aprox para A4 landscape)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Definimos un tama√±o est√°ndar alto (ej. 3508x2480px es A4 a 300dpi)
        // Pero para mantener proporciones usaremos el alto de la plantilla
        const h = 1800; 
        const lw = (leftImg.width * h) / leftImg.height;
        const rw = (tplImg.width * h) / tplImg.height;
        
        canvas.width = lw + rw;
        canvas.height = h;

        // 1. Dibujar imagen izquierda
        ctx.drawImage(leftImg, 0, 0, lw, h);

        // 2. Dibujar fondo de hoja derecha
        ctx.drawImage(tplImg, lw, 0, rw, h);

        // 3. Configurar texto estilo infantil
        const padding = rw * 0.15; // 15% de margen
        const textWidth = rw - (padding * 2);
        const startX = lw + padding;
        const startY = h * 0.25;

        // Dibujar Letra Capital
        if (textoPagina.length > 0) {
            ctx.fillStyle = "#2c3e50";
            ctx.font = "bold 160px 'Patrick Hand', cursive";
            const firstLetter = textoPagina.charAt(0).toUpperCase();
            const restText = textoPagina.slice(1);
            
            ctx.fillText(firstLetter, startX, startY);
            
            // Texto normal
            ctx.font = "70px 'Patrick Hand', cursive";
            wrapText(ctx, restText, startX + 90, startY, textWidth - 80, 85);
        }

        // 4. Agregar Logo GracePrint al centro inferior derecho
        ctx.font = "bold 40px Arial";
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.textAlign = "center";
        ctx.fillText("GracePrint", lw + (rw / 2), h - 60);
        ctx.textAlign = "left"; // reset

        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        paginasGeneradas.push({url: dataUrl, w: canvas.width, h: canvas.height});
        
        const previewImg = document.createElement('img');
        previewImg.src = dataUrl;
        previewDiv.appendChild(previewImg);
    }
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
    const words = text.split(' ');
    let line = '';

    for (let n = 0; n < words.length; n++) {
        let testLine = line + words[n] + ' ';
        let metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && n > 0) {
            ctx.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
            x = x - 90; // Volvemos al margen original despu√©s de la letra capital
            // Ajuste simple: despu√©s de la primera l√≠nea, el ancho permitido vuelve a ser el total
            maxWidth = maxWidth + 80; 
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, x, y);
}

function loadImg(file) {
    return new Promise(res => {
        const i = new Image();
        i.onload = () => res(i);
        i.src = URL.createObjectURL(file);
    });
}

function exportarPDF() {
    if (!paginasGeneradas.length) return alert('Primero genera las p√°ginas.');
    const { jsPDF } = window.jspdf;
    
    // El primer folio define el tama√±o
    const first = paginasGeneradas[0];
    const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'px',
        format: [first.w, first.h]
    });

    paginasGeneradas.forEach((pag, i) => {
        if (i > 0) pdf.addPage([pag.w, pag.h], 'landscape');
        pdf.addImage(pag.url, 'JPEG', 0, 0, pag.w, pag.h);
    });

    pdf.save('Mi_Cuento_GracePrint.pdf');
}
</script>
</body>
</html>
